<?xml version="1.0" encoding="UTF-8"?>
<project name="shared-build">
    <dirname property="shared.build.file.dir" file="${ant.file.shared-build}"/>
    <loadproperties srcfile="${shared.build.file.dir}/build.properties"/>
    <property name="compiler.args.application" value=""/>
    <property name="output.production.dir" value="../out/production"/>
    <property name="output.test.dir" value="../out/test"/>

    <path id="production.classpath">
        <path path="${jdk.classpath}"/>
        <path path="lib/ant-contrib-1.0b3.jar"/>
        <path path="lib/ant.jar"/>
    </path>

    <macrodef name="init-module">
        <attribute name="module"/>
        <sequential>
            <path id="@{module}.source.path">
                <dirset dir=".">
                    <include name="src"/>
                </dirset>
            </path>

            <path id="@{module}.test.path">
                <dirset dir=".">
                    <include name="test"/>
                </dirset>
            </path>
        </sequential>
    </macrodef>

    <macrodef name="compile">
        <attribute name="module"/>
        <attribute name="code.path"/>
        <attribute name="output.dir"/>
        <sequential>
            <init-module module="@{module}"/>
            <mkdir dir="@{output.dir}/@{module}"/>
            <javac destdir="@{output.dir}/@{module}" fork="true" includeantruntime="false">
                <compilerarg line="${compiler.args.application}"/>
                <classpath refid="production.classpath"/>
                <src refid="@{code.path}"/>
            </javac>
        </sequential>
    </macrodef>

    <macrodef name="compile-module-source">
        <attribute name="module"/>
        <sequential>
            <compile module="@{module}" output.dir="${output.production.dir}" code.path="@{module}.source.path"/>
            <copy todir="${output.production.dir}/@{module}">
                <fileset dir="resources" erroronmissingdir="false"/>
            </copy>
        </sequential>
    </macrodef>

    <macrodef name="compile-module-test">
        <attribute name="module"/>
        <sequential>
            <compile module="@{module}" output.dir="${output.test.dir}" code.path="@{module}.test.path"/>
        </sequential>
    </macrodef>

    <macrodef name="clean-module">
        <attribute name="module"/>
        <sequential>
            <delete dir="${output.production.dir}/@{module}"/>
            <delete dir="${output.test.dir}/@{module}"/>
        </sequential>
    </macrodef>
</project>